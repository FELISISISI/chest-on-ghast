# 快乐恶魂战斗系统说明

## 功能概述

快乐恶魂现在拥有完整的自动战斗AI系统！当玩家周围出现敌对生物时，快乐恶魂会自动进入战斗状态，发射火球保护玩家。

## 核心特性

### 1. 自动敌对生物检测
- **检测范围**：16格半径内
- **目标类型**：所有敌对生物（僵尸、骷髅、爬行者、末影人等）
- **智能选择**：自动锁定最近的敌对生物
- **持续追踪**：目标离开18格范围前会持续攻击

### 2. 等级化火球威力

快乐恶魂的攻击能力随等级显著提升：

| 等级 | 火球威力 | 攻击冷却 | 每分钟攻击次数 | DPS（估算） |
|------|---------|---------|---------------|-------------|
| 1级  | 1       | 3.0秒   | 20次          | 0.33        |
| 2级  | 2       | 2.5秒   | 24次          | 0.8         |
| 3级  | 3       | 2.0秒   | 30次          | 1.5         |
| 4级  | 4       | 1.5秒   | 40次          | 2.67        |
| 5级  | 5       | 1.0秒   | 60次          | 5.0         |
| 6级  | 6       | 0.75秒  | 80次          | 8.0         |

**威力说明**：
- 火球威力决定爆炸范围和伤害
- 6级快乐恶魂的DPS是1级的24倍！
- 火球会造成范围爆炸伤害

### 3. AI行为特点

✅ **自动激活**：无需玩家操作，自动检测并攻击
✅ **保护优先**：优先攻击最近的威胁
✅ **视线追踪**：攻击时会看向目标
✅ **精准发射**：计算目标位置和速度
✅ **音效反馈**：发射火球时播放音效
✅ **服务端执行**：只在服务端运行，避免重复攻击

## 工作原理

### AI Goal 优先级
```
优先级 1: 战斗AI（AttackHostileGoal）- 最高优先级
优先级 3: 跟随持有食物的玩家（FollowPlayerWithFoodGoal）
```

战斗AI具有最高优先级，确保快乐恶魂在有威胁时优先战斗。

### 战斗流程

1. **检测阶段**
   - 每tick扫描16格范围内的敌对生物
   - 过滤掉已死亡或不可攻击的目标
   - 选择距离最近的敌对生物

2. **锁定阶段**
   - 锁定目标后进入战斗状态
   - 持续追踪目标直到其离开18格范围
   - 看向目标保持瞄准

3. **攻击阶段**
   - 根据等级应用攻击冷却时间
   - 冷却结束后立即发射火球
   - 计算目标方向和速度
   - 从恶魂眼睛位置发射火球

4. **循环阶段**
   - 发射后重置冷却计时器
   - 继续追踪直到目标死亡或逃离
   - 目标消失后重新扫描新威胁

## 使用建议

### 初期（1-2级）
- 火力较弱，适合对付单个怪物
- 建议玩家协助战斗
- 攻击冷却较长，注意保护快乐恶魂

### 中期（3-4级）
- 火力明显提升，可独立对抗小群怪物
- 解锁效果云系统（3级+）
- 攻击速度加快，控场能力增强

### 后期（5-6级）
- 超强火力，可轻松清理大量怪物
- 极快的攻击速度（0.75-1秒一次）
- 成为玩家最强力的战斗伙伴

## 战术应用

### 1. 基地防御
- 将快乐恶魂停留在基地附近
- 自动清理接近的怪物
- 配合围墙形成完美防线

### 2. 探险保护
- 带着快乐恶魂探索洞穴
- 提前发现并清理威胁
- 高等级恶魂可单独清场

### 3. 夜晚生存
- 夜晚怪物自动被清理
- 提供持续的范围保护
- 安心进行建造工作

### 4. 地牢探险
- 在地牢中清理怪物
- 配合效果云系统提供治疗
- 快速高效完成探险

## 配合其他系统

### 与饱食度系统配合
- 战斗消耗体力，需定期喂食
- 保持饱食度确保战斗力
- 高等级恶魂饱食度消耗更慢

### 与等级系统配合
- 通过喂食提升等级
- 等级越高战斗力越强
- 培养6级恶魂获得最强战力

### 与效果云系统配合（3级+）
- 火球击中后生成效果云
- 对怪物造成持续伤害
- 对玩家提供治疗和速度加成

## 技术实现细节

### 代码位置
- **文件**：`src/main/java/me/noramibu/mixin/HappyGhastEntityMixin.java`
- **类**：`AttackHostileGoal`（内部类）
- **注册位置**：`onInit` 方法

### 关键参数
```java
// 火球威力（根据等级）
int fireballPower = switch (level) {
    case 1 -> 1;
    case 2 -> 2;
    case 3 -> 3;
    case 4 -> 4;
    case 5 -> 5;
    case 6 -> 6;
    default -> 1;
};

// 攻击冷却时间（根据等级）
int cooldownTicks = switch (level) {
    case 1 -> 60;  // 3.0秒
    case 2 -> 50;  // 2.5秒
    case 3 -> 40;  // 2.0秒
    case 4 -> 30;  // 1.5秒
    case 5 -> 20;  // 1.0秒
    case 6 -> 15;  // 0.75秒
    default -> 60;
};
```

### 可调整参数
如需修改战斗系统参数，可编辑以下部分：
- **检测范围**：第114-116行的 `expand(16.0)`
- **追踪范围**：第144行的 `18.0 * 18.0`
- **火球威力**：第177-185行的 `getFireballPower` 方法
- **冷却时间**：第192-201行的 `getCooldownTicks` 方法

## 性能优化

- ✅ 只在服务端执行（避免客户端重复计算）
- ✅ 使用范围预筛选（减少检测次数）
- ✅ 智能目标缓存（避免频繁重新扫描）
- ✅ 冷却时间控制（避免过度发射）

## 已知限制

1. **不攻击被动生物**：只攻击HostileEntity类型的敌对生物
2. **单目标锁定**：同一时间只攻击一个目标
3. **需要视野**：无法攻击视线被阻挡的目标
4. **固定范围**：检测范围固定为16格

## 未来扩展可能

- [ ] 可配置的检测范围
- [ ] 多目标同时攻击
- [ ] 特殊攻击模式（如连发）
- [ ] 战斗经验值获取
- [ ] 击杀统计
- [ ] 自定义攻击优先级

## 版本信息

- **实现版本**：1.0.3
- **Minecraft版本**：1.21.9
- **实现日期**：2025-11-21

---

**享受快乐恶魂带来的强大保护吧！** 🎯🔥
